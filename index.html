<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00ff88; --red: #ff4d4d; --bg: #080a0f; --card: #131720; --text: #e0e6ed; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; text-align: center; margin: 0; padding-bottom: 40px; }
        
        /* HEADER & BALANCE */
        .header { padding: 20px; background: radial-gradient(circle at center, #1a2332 0%, var(--bg) 70%); }
        .balance-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.6; }
        .balance-val { font-size: 48px; font-weight: 900; color: white; text-shadow: 0 0 20px rgba(0,255,136,0.2); margin: 5px 0; }
        .currency { font-size: 16px; color: var(--primary); }

        /* NAV PILLS */
        .nav { display: flex; justify-content: center; gap: 8px; margin: 10px 20px; background: #1c222e; padding: 5px; border-radius: 12px; }
        .nav-item { flex: 1; padding: 10px; font-size: 12px; font-weight: 700; border-radius: 8px; cursor: pointer; transition: 0.2s; opacity: 0.5; }
        .nav-item.active { background: #2b3545; color: white; opacity: 1; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

        /* GAME AREA */
        .game-card { background: var(--card); margin: 15px; border-radius: 24px; padding: 25px; border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden; }
        .display { font-size: 72px; height: 100px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        
        /* INPUTS & BUTTONS */
        .controls { display: flex; gap: 10px; margin-top: 20px; }
        input { background: #0b0e14; border: 1px solid #2b3545; color: white; padding: 15px; border-radius: 14px; width: 100%; font-weight: bold; font-size: 16px; text-align: center; outline: none; }
        .btn-play { background: var(--primary); color: #000; border: none; padding: 15px; width: 100%; border-radius: 14px; font-weight: 900; font-size: 16px; cursor: pointer; box-shadow: 0 0 15px rgba(0,255,136,0.3); }
        .btn-play:active { transform: scale(0.98); }

        /* HISTORY LIST */
        .history-section { margin: 20px; text-align: left; }
        .history-title { font-size: 12px; font-weight: bold; color: #5f6b7c; margin-bottom: 10px; text-transform: uppercase; }
        .history-list { display: flex; flex-direction: column; gap: 8px; }
        .h-item { display: flex; justify-content: space-between; background: var(--card); padding: 12px 16px; border-radius: 12px; font-size: 13px; align-items: center; }
        .h-left { display: flex; flex-direction: column; gap: 2px; }
        .h-type { font-weight: 700; color: white; }
        .h-time { font-size: 10px; color: #5f6b7c; }
        .h-amount { font-weight: bold; font-size: 14px; }
        .win { color: var(--primary); }
        .loss { color: var(--red); }

        /* ANIMATIONS */
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 100% { transform: translate(-1px, -2px) rotate(-1deg); } }
        .shaking { animation: shake 0.1s infinite; }
    </style>
</head>
<body>

    <div class="header">
        <div class="balance-label">Total Balance</div>
        <div class="balance-val" id="bal">0.00 <span class="currency">TON</span></div>
    </div>

    <div class="nav">
        <div id="nav-slots" class="nav-item active" onclick="switchGame('slots')">SLOTS</div>
        <div id="nav-dice" class="nav-item" onclick="switchGame('dice')">DICE</div>
        <div id="nav-mines" class="nav-item" onclick="switchGame('mines')">MINES</div>
        <div id="nav-earn" class="nav-item" onclick="switchGame('earn')">EARN</div>
    </div>

    <div id="game-ui" class="game-card">
        <div id="display" class="display">ðŸŽ°ðŸŽ°ðŸŽ°</div>
        
        <div id="mines-controls" style="display:none; margin-bottom:15px;">
            <label style="font-size:12px; color:#666;">Mines Amount (1-9)</label>
            <input type="number" id="mCount" value="3" min="1" max="9">
        </div>

        <div class="controls">
            <input type="number" id="bet" placeholder="0.5">
            <button class="btn-play" onclick="play()">PLAY</button>
        </div>
    </div>

    <div id="earn-ui" class="game-card" style="display:none; text-align:center;">
        <h3 style="margin:0 0 10px 0;">ðŸš€ Free Crypto</h3>
        <p style="font-size:13px; color:#888; margin-bottom:20px;">Join our channel @starrussi to get 0.05 TON free.</p>
        <button class="btn-play" style="background:#2b9cd9; color:white; margin-bottom:10px;" onclick="Telegram.WebApp.openTelegramLink('https://t.me/starrussi')">JOIN CHANNEL</button>
        <button class="btn-play" style="background:#1c222e; color:white; border:1px solid #333;" onclick="checkTask()">CHECK & CLAIM</button>
    </div>

    <div style="display:flex; gap:10px; margin:0 15px;">
        <button class="btn-play" style="background:#2b3545; color:white; font-size:13px;" onclick="doTransact('DEP')">â¬‡ DEPOSIT</button>
        <button class="btn-play" style="background:#2b3545; color:white; font-size:13px;" onclick="doTransact('WIT')">â¬† WITHDRAW</button>
    </div>

    <div class="history-section">
        <div class="history-title">Recent Transactions</div>
        <div id="history-list" class="history-list">
            </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const uid = tg.initDataUnsafe.user?.id || 7019851823;
        let curGame = 'slots';

        // SYNC DATA & HISTORY
        async function sync() {
            const r = await fetch('/api/user-data', { 
                method: 'POST', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({id: uid}) 
            });
            const d = await r.json();
            
            // Update Balance
            document.getElementById('bal').innerHTML = `${d.balance.toFixed(2)} <span class="currency">TON</span>`;

            // Update History List
            const hList = document.getElementById('history-list');
            hList.innerHTML = ''; // Clear
            if(d.history && d.history.length > 0) {
                d.history.forEach(h => {
                    const isPos = h.amount.includes('+');
                    const colorClass = isPos ? 'win' : 'loss';
                    const html = `
                        <div class="h-item">
                            <div class="h-left">
                                <span class="h-type">${h.type}</span>
                                <span class="h-time">${h.time}</span>
                            </div>
                            <span class="h-amount ${colorClass}">${h.amount} ${h.asset || 'TON'}</span>
                        </div>`;
                    hList.insertAdjacentHTML('beforeend', html);
                });
            } else {
                hList.innerHTML = '<div style="text-align:center; opacity:0.3; font-size:12px;">No activity yet</div>';
            }
        }

        // GAMEPLAY
        async function play() {
            const bet = document.getElementById('bet').value;
            if(!bet || bet <= 0) return tg.showAlert("Please enter a valid amount");

            const disp = document.getElementById('display');
            disp.classList.add('shaking'); // Animation Start

            const r = await fetch('/api/play', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    id: uid, 
                    bet: parseFloat(bet), 
                    game: curGame,
                    minesCount: parseInt(document.getElementById('mCount').value)
                })
            });
            
            const d = await r.json();

            setTimeout(() => {
                disp.classList.remove('shaking');
                
                // Show Result
                if(d.error) {
                    tg.showAlert(d.error);
                } else {
                    if(curGame === 'dice') disp.innerText = `ðŸŽ² ${d.result}`;
                    else if(curGame === 'slots') disp.innerText = d.result.join('');
                    else disp.innerText = d.result; // Mines result

                    if(d.win > 0) tg.showAlert(`YOU WON! +${d.win.toFixed(2)} TON`);
                }
                sync(); // Refresh History & Balance
            }, 800); // Wait for animation
        }

        // UI SWITCHING
        function switchGame(g) {
            curGame = g;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${g}`).classList.add('active');

            const ui = document.getElementById('game-ui');
            const earn = document.getElementById('earn-ui');
            const disp = document.getElementById('display');

            if(g === 'earn') {
                ui.style.display = 'none';
                earn.style.display = 'block';
            } else {
                ui.style.display = 'block';
                earn.style.display = 'none';
                document.getElementById('mines-controls').style.display = (g === 'mines') ? 'block' : 'none';
                
                if(g === 'dice') disp.innerText = 'ðŸŽ²';
                else if(g === 'slots') disp.innerText = 'ðŸŽ°ðŸŽ°ðŸŽ°';
                else disp.innerText = 'ðŸ’£';
            }
        }

        // TASK & TRANS (Placeholders linking to previous API)
        async function checkTask() {
            const r = await fetch('/api/check-task', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:uid})});
            const d = await r.json();
            tg.showAlert(d.message);
            sync();
        }

        function doTransact(type) {
             // Logic for Deposit/Withdraw modal (Keep your previous logic here)
             tg.showAlert(type === 'DEP' ? "Opening Deposit..." : "Opening Withdraw...");
             // Call openP() from previous code here
        }

        // Init
        sync();
        setInterval(sync, 5000); // Auto-refresh history every 5s
    </script>
</body>
</html>
