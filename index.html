<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --neon: #00d2ff; --bg: #050505; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; text-align: center; margin: 0; padding-bottom: 70px; }
        .card { background: #111; border-radius: 20px; margin: 12px; padding: 20px; border: 1px solid #222; }
        .balance { font-size: 36px; font-weight: bold; color: var(--neon); text-shadow: 0 0 15px rgba(0,210,255,0.3); }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-play { background: linear-gradient(90deg, #00d2ff, #0072ff); color: white; }
        .nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; border-top: 1px solid #333; }
        .nav-item { flex: 1; padding: 15px; font-size: 12px; opacity: 0.5; cursor: pointer; }
        .active { opacity: 1; color: var(--neon); }
        .hidden { display: none; }
        input { width: 85%; padding: 12px; background: #1a1a1a; border: 1px solid #333; color: white; border-radius: 10px; text-align: center; margin-bottom: 10px; }
        #display { font-size: 60px; height: 100px; display: flex; align-items: center; justify-content: center; }
        .spinning { animation: rotate 0.1s infinite linear; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="game-page">
    <div class="card">
        <div style="opacity: 0.5; font-size: 11px; letter-spacing: 1px;">TOTAL BALANCE</div>
        <div id="bal" class="balance">0.00 TON</div>
    </div>

    <div class="card">
        <div id="display">üé≤</div>
        <select id="game-type" class="btn" style="background:#222; color:white; border:1px solid #444;">
            <option value="dice">üé≤ Dice (x4 Multiplier)</option>
            <option value="slots">üé∞ Slots (x15 Multiplier)</option>
        </select>
        <input type="number" id="bet" placeholder="Bet Amount (TON)">
        <button class="btn btn-play" onclick="play()">SPIN & WIN</button>
    </div>
</div>

<div id="wallet-page" class="hidden">
    <div class="card">
        <h3>Wallet</h3>
        <button class="btn" style="background:#ffbc00;" onclick="payStars()">‚≠ê RECHARGE STARS (Min. 5)</button>
        <button class="btn" style="background:#222; color:white; border:1px solid #444;" onclick="payCrypto()">üíé CRYPTOBOT (TON)</button>
        <hr style="border:0.1px solid #333; margin:20px 0;">
        <input type="number" id="wit-amt" placeholder="Withdraw Amount (TON)">
        <button class="btn" style="background:#ff4444;" onclick="withdraw()">WITHDRAW (Min. 1 TON)</button>
    </div>
</div>

<div id="ref-page" class="hidden">
    <div class="card">
        <h3>Referral Program</h3>
        <div style="font-size:40px;">üë•</div>
        <p>Invite friends and earn <span style="color:var(--neon);">30%</span> of their wins!</p>
        <div class="card" style="background:#000; border-color:var(--neon);">
            <div id="ref-count" style="font-size:24px;">0</div>
            <div style="font-size:10px;">FRIENDS INVITED</div>
        </div>
        <button class="btn btn-play" onclick="copyRef()">COPY INVITE LINK</button>
        <p style="font-size:10px; margin-top:15px; color:#666;">Invite 500 users to get 500 Stars Bonus!</p>
    </div>
</div>

<nav class="nav">
    <div class="nav-item active" onclick="tab('game', this)">Games</div>
    <div class="nav-item" onclick="tab('wallet', this)">Wallet</div>
    <div class="nav-item" onclick="tab('ref', this)">Referral</div>
</nav>

<script>
    const tg = window.Telegram.WebApp;
    const uid = tg.initDataUnsafe.user?.id || 7019851823;

    function tab(name, el) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        ['game', 'wallet', 'ref'].forEach(p => document.getElementById(p+'-page').classList.add('hidden'));
        document.getElementById(name+'-page').classList.remove('hidden');
    }

    async function sync() {
        const r = await fetch('/api/user-data', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:uid}) });
        const d = await r.json(); 
        document.getElementById('bal').innerText = d.balance.toFixed(2) + " TON";
        document.getElementById('ref-count').innerText = d.referrals || 0;
    }

    async function play() {
        const bet = document.getElementById('bet').value;
        const game = document.getElementById('game-type').value;
        const disp = document.getElementById('display');
        if(!bet || bet <= 0) return tg.showAlert("Please enter a bet");

        disp.classList.add('spinning');
        const r = await fetch('/api/play', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:uid, bet, game}) });
        const d = await r.json();

        setTimeout(() => {
            disp.classList.remove('spinning');
            if(d.error) return tg.showAlert(d.error);
            disp.innerText = Array.isArray(d.result) ? d.result.join('') : d.result;
            if(d.win > 0) {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("BIG WIN! +"+d.win+" TON");
            } else {
                tg.HapticFeedback.notificationOccurred('error');
            }
            sync();
        }, 600);
    }

    function copyRef() {
        const link = `https://t.me/Newspin_onebot?start=${uid}`;
        const input = document.createElement('input');
        document.body.appendChild(input);
        input.value = link;
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        tg.showAlert("Invite link copied!");
    }

    async function payStars() {
        const amt = prompt("How many Stars? (Min. 5)");
        if(amt < 5) return tg.showAlert("Minimum is 5 Stars");
        const r = await fetch('/api/deposit-stars', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:uid, amount:amt}) });
        const d = await r.json();
        if(d.url) tg.openTelegramLink(d.url);
    }

    async function withdraw() {
        const amt = document.getElementById('wit-amt').value;
        const r = await fetch('/api/withdraw', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:uid, amount:amt}) });
        const d = await r.json();
        tg.showAlert(d.success ? "Success!" : d.error);
        sync();
    }

    sync();
</script>
</body>
</html>
