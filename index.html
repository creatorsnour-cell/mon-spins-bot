<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --neon: #00f2ff; --pink: #ff0055; --bg: #050a10; }
        body { background: var(--bg); color: white; font-family: sans-serif; text-align: center; margin: 0; padding-bottom: 80px; }
        .glass-header { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); padding: 20px; border-bottom: 1px solid var(--neon); }
        .balance-box { font-size: 32px; color: var(--neon); text-shadow: 0 0 10px var(--neon); font-weight: bold; }
        
        .card { background: rgba(255,255,255,0.05); margin: 15px; padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
        #display-area { font-size: 70px; margin: 25px 0; min-height: 85px; transition: 0.2s; }
        
        .btn { background: none; border: 1px solid var(--neon); color: var(--neon); padding: 15px; border-radius: 50px; width: 100%; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .btn:active { background: var(--neon); color: black; }
        
        input { background: rgba(0,0,0,0.3); border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; width: 85%; text-align: center; font-size: 16px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="glass-header">
        <div style="font-size: 12px; opacity: 0.6;">SOLDE ACTUEL</div>
        <div class="balance-box" id="userBal">0.00</div>
    </div>

    <div class="card">
        <select id="gameSelect" style="background:none; color:white; border:none; margin-bottom:15px; font-size:16px;">
            <option value="slots">üé∞ MACHINE √Ä SOUS</option>
            <option value="dice">üé≤ D√âS CYBER</option>
        </select>
        <div id="display-area">üé∞</div>
        <input type="number" id="bet" placeholder="MONTANT DE LA MISE">
        <button class="btn" onclick="startGame()">PARIER ET LANCER</button>
    </div>

    <div class="card" style="display: flex; gap: 10px;">
        <button onclick="pay('STARS')" style="flex:1; background:none; color:gold; border:1px solid gold; border-radius:10px; padding:10px; font-size:10px;">D√âP√îT ‚≠ê</button>
        <button onclick="pay('TON')" style="flex:1; background:none; color:#0088cc; border:1px solid #0088cc; border-radius:10px; padding:10px; font-size:10px;">D√âP√îT TON</button>
        <button onclick="withdraw()" style="flex:1; background:none; color:var(--pink); border:1px solid var(--pink); border-radius:10px; padding:10px; font-size:10px;">RETRAIT</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe.user;
        let userId = user ? user.id : 123;
        let userName = user ? user.first_name : "Joueur";

        async function startGame() {
            const bet = parseFloat(document.getElementById('bet').value);
            const game = document.getElementById('gameSelect').value;
            const area = document.getElementById('display-area');

            if (isNaN(bet) || bet <= 0) return tg.showAlert("Mise invalide");

            area.style.transform = "scale(1.2)";
            area.innerText = "üåÄ";

            const r = await fetch('/api/play', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: userId, bet, game })
            });
            const data = await r.json();

            if(data.error) {
                area.style.transform = "scale(1)";
                area.innerText = "‚ùå";
                return tg.showAlert(data.error);
            }

            setTimeout(() => {
                area.style.transform = "scale(1)";
                area.innerText = Array.isArray(data.result) ? data.result.join(' ') : (data.result === 1 ? '‚öÄ' : data.result === 2 ? '‚öÅ' : data.result === 3 ? '‚öÇ' : data.result === 4 ? '‚öÉ' : data.result === 5 ? '‚öÑ' : '‚öÖ');
                document.getElementById('userBal').innerText = data.newBalance.toFixed(2);
                if(data.win > 0) tg.HapticFeedback.notificationOccurred('success');
            }, 800);
        }

        async function pay(asset) {
            const amount = prompt("Montant du d√©p√¥t ?");
            if(!amount) return;
            const r = await fetch('/api/deposit', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: userId, amount, asset })
            });
            const data = await r.json();
            if(data.success) tg.openTelegramLink(data.url);
        }

        async function withdraw() {
            const amount = prompt("Montant √† retirer ?");
            const address = prompt("Adresse de retrait (TON/USDT/ID xRocket) :");
            if(amount && address) {
                const r = await fetch('/api/withdraw', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: userId, name: userName, amount, address, asset: 'CRYPTO' })
                });
                const res = await r.json();
                tg.showAlert(res.message);
            }
        }
    </script>
</body>
</html>
